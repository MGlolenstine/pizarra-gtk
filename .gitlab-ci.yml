stages:
  - build
  - deploy

variables:
  COMMITER_NAME: Abraham Toriz
  COMMITER_EMAIL: categulario+gitlabci@gmail.com

build:
  stage: build
  image: categulario/pizarra-ci-builds:1.0.1
  script:
    # build the binary
    - cargo build --locked --release
    # create the tar package
    - mkdir -p build
      # move things to the build directory
    - cp target/release/pizarra build/pizarra
    - cp res/icons/tk.categulario.pizarra.svg build/pizarra.svg
    - cp res/pizarra.desktop build/pizarra.desktop
    - cp CHANGELOG.md build/CHANGELOG.md
    - cp README.md build/README.md
    - cp LICENSE build/LICENSE
      # compress the tar file
    - tar -cvzf pizarra_${CI_COMMIT_TAG:1}_x86-64.tar.gz build/
      # makes the debian archive
    - ./debpackage.sh
      # computes the sums
    - sha256sum pizarra_${CI_COMMIT_TAG:1}_x86-64.tar.gz > pizarra_${CI_COMMIT_TAG:1}_x86-64.tar.gz.sum
    - sha256sum debian-package/pizarra_${CI_COMMIT_TAG:1}_amd64.deb > pizarra_${CI_COMMIT_TAG:1}_amd64.deb.sum
  artifacts:
    paths:
      - pizarra_${CI_COMMIT_TAG:1}_x86-64.tar.gz
      - debian-package/pizarra_${CI_COMMIT_TAG:1}_amd64.deb
      - pizarra_${CI_COMMIT_TAG:1}_x86-64.tar.gz.sum
      - pizarra_${CI_COMMIT_TAG:1}_amd64.deb.sum
  rules:
    - if: '$CI_COMMIT_TAG =~ /v*/'

upload:
  stage: deploy
  image: kroniak/ssh-client
  script:
  - mkdir -p ~/.ssh
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$PRIVATE_KEY")
  - scp pizarra_${CI_COMMIT_TAG:1}_x86-64.tar.gz $SERVER_USER@$SERVER_HOST:$LINUX_RELEASE_PATH
  - scp pizarra_${CI_COMMIT_TAG:1}_x86-64.tar.gz.sum $SERVER_USER@$SERVER_HOST:$LINUX_RELEASE_PATH
  - scp debian-package/pizarra_${CI_COMMIT_TAG:1}_amd64.deb $SERVER_USER@$SERVER_HOST:$DEBIAN_RELEASE_PATH
  - scp pizarra_${CI_COMMIT_TAG:1}_amd64.deb.sum $SERVER_USER@$SERVER_HOST:$DEBIAN_RELEASE_PATH
  rules:
    - if: '$CI_COMMIT_TAG =~ /v*/'

deploy:arch-bin:
  stage: deploy
  image: chakralinux/makepkg
  script:
    # become this user
    - sudo su builder
    - cd
    # setup ssh
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$ARCH_PRIVATE_KEY")
    # setup git, because we'll commit
    - git config --global user.name "$COMMITER_NAME"
    - git config --global user.email "$COMMITER_EMAIL"
    # finally run the script
    - ./scripts/release-aur-bin.sh
  rules:
    - if: '$CI_COMMIT_TAG =~ /v*/'

deploy:arch-git:
  stage: deploy
  image: chakralinux/makepkg
  script:
    # become this user
    - sudo su builder
    - cd
    # setup ssh
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$ARCH_PRIVATE_KEY")
    # setup git, because we'll commit
    - git config --global user.name "$COMMITER_NAME"
    - git config --global user.email "$COMMITER_EMAIL"
    # finally run the script
    - ./scripts/release-aur-git.sh
  rules:
    - if: '$CI_COMMIT_TAG =~ /v*/'
